<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Newsletter Dashboard</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        overflow: hidden;
        height: 100vh;
        padding: 20px;
      }
      .main-container {
        height: calc(100vh - 40px);
        overflow: hidden;
      }
      .content-row {
        height: calc(100vh - 120px);
        overflow: hidden;
      }
      .left-column {
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .topic-section {
        height: 50%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .blogs-section {
        height: 50%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-top: 1rem;
      }
      .blog-content {
        height: 100%;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
        padding: 20px;
      }
      .topic-list {
        height: 168px; /* Exactly 3 items: 3 * (48px item height + 8px margin) */
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
      }
      .blogs-container {
        flex: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
      }
      /* Common scrollbar styling for all scrollable containers */
      .topic-list::-webkit-scrollbar,
      .blogs-container::-webkit-scrollbar,
      .blog-content::-webkit-scrollbar {
        width: 6px;
      }
      .topic-list::-webkit-scrollbar-track,
      .blogs-container::-webkit-scrollbar-track,
      .blog-content::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 3px;
      }
      .topic-list::-webkit-scrollbar-thumb,
      .blogs-container::-webkit-scrollbar-thumb,
      .blog-content::-webkit-scrollbar-thumb {
        background-color: #6c757d;
        border-radius: 3px;
      }
      .loader {
        display: none;
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #3498db;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loading-container {
        position: relative;
      }
      .loading-container .loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .list-group-item {
        height: 48px; /* Fixed height for topic items */
        margin-bottom: 8px;
        border-radius: 4px !important;
        display: flex;
        align-items: center;
      }
      .list-group-item:last-child {
        margin-bottom: 0;
      }
      .content-viewer {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .card-body {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .tab-content {
        flex: 1;
        overflow: hidden;
      }
      .tab-pane {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid main-container">
      <!-- Main Tabs -->
      <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="generate-tab"
            data-bs-toggle="tab"
            data-bs-target="#generate"
            type="button"
            role="tab"
          >
            Generate
          </button>
        </li>
        <li class="nav-item ms-auto" role="presentation">
          <button class="nav-link" onclick="logout()" type="button">
            Logout
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="mainTabsContent">
        <!-- Generate Tab -->
        <div class="tab-pane fade show active" id="generate" role="tabpanel">
          <div class="row content-row">
            <!-- Left Side - Topics and Blogs -->
            <div class="col-md-5 left-column">
              <!-- Topic Generation Section -->
              <div class="card topic-section">
                <div class="card-header">
                  <h5 class="mb-0">Topic Generation</h5>
                </div>
                <div class="card-body">
                  <form id="topicForm">
                    <div class="mb-3">
                      <label class="form-label">Topic Generation Method</label>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="topicMethod"
                          id="suggestTopic"
                          checked
                        />
                        <label class="form-check-label" for="suggestTopic">
                          Suggest Topic
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="topicMethod"
                          id="manualTopic"
                        />
                        <label class="form-check-label" for="manualTopic">
                          Add Topic Manually
                        </label>
                      </div>
                    </div>
                    <div
                      class="mb-3"
                      id="manualTopicInput"
                      style="display: none"
                    >
                      <label for="topicInput" class="form-label"
                        >Enter Topic</label
                      >
                      <input type="text" class="form-control" id="topicInput" />
                    </div>
                    <button
                      type="submit"
                      class="btn btn-primary d-flex align-items-center"
                    >
                      <span>Generate/Add Topic</span>
                      <div class="loader" id="topicFormLoader"></div>
                    </button>
                  </form>

                  <!-- Latest Topics -->
                  <div class="mt-3">
                    <h6
                      class="d-flex justify-content-between align-items-center"
                    >
                      <span>Available Topics</span>
                      <small class="text-muted"
                        >Showing 3 topics at a time</small
                      >
                    </h6>
                    <div class="topic-list loading-container">
                      <div class="list-group" id="topicsList">
                        <!-- Topics will be dynamically added here -->
                      </div>
                      <div class="loader" id="topicsLoader"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Blogs Section -->
              <div class="card blogs-section">
                <div class="card-header">
                  <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link active"
                        id="pending-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#pending"
                        type="button"
                        role="tab"
                      >
                        Pending
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link"
                        id="approved-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#approved"
                        type="button"
                        role="tab"
                      >
                        Approved
                      </button>
                    </li>
                  </ul>
                </div>
                <div class="card-body">
                  <div class="tab-content h-100">
                    <!-- Pending Blogs -->
                    <div
                      class="tab-pane fade show active blogs-container loading-container"
                      id="pending"
                      role="tabpanel"
                    >
                      <div class="list-group" id="pendingList">
                        <!-- Pending blogs will be dynamically added here -->
                      </div>
                      <div class="loader" id="pendingLoader"></div>
                    </div>
                    <!-- Approved Blogs -->
                    <div
                      class="tab-pane fade blogs-container loading-container"
                      id="approved"
                      role="tabpanel"
                    >
                      <div class="list-group" id="approvedList">
                        <!-- Approved blogs will be dynamically added here -->
                      </div>
                      <div class="loader" id="approvedLoader"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Side - Blog Content Viewer -->
            <div class="col-md-7" style="height: 100%">
              <div class="card content-viewer">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h5 class="mb-0">Blog Content</h5>
                  <div>
                    <button
                      id="copyHtmlBtn"
                      class="btn btn-sm btn-secondary me-2"
                      onclick="copyBlogHtml()"
                      style="display: none"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-clipboard"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"
                        />
                        <path
                          d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"
                        />
                      </svg>
                      Copy HTML
                    </button>
                    <button
                      id="saveChangesBtn"
                      class="btn btn-sm btn-primary me-2"
                      onclick="saveBlogContent()"
                      style="display: none"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-save"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"
                        />
                      </svg>
                      Save Changes
                    </button>
                    <button
                      id="editBlogBtn"
                      class="btn btn-sm btn-primary"
                      onclick="toggleBlogEdit()"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-pencil"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"
                        />
                      </svg>
                      Edit
                    </button>
                  </div>
                </div>
                <div class="card-body loading-container">
                  <div class="blog-content">
                    <div id="blogContent" class="prose">
                      Select a blog to view its content.
                    </div>
                    <div id="blogEditor" style="display: none">
                      <textarea
                        id="blogContentEditor"
                        class="form-control"
                        style="height: 100%; min-height: 400px"
                      ></textarea>
                      <div class="mt-3 d-flex justify-content-end">
                        <button
                          class="btn btn-secondary me-2"
                          onclick="cancelBlogEdit()"
                        >
                          Cancel
                        </button>
                        <button
                          id="previewBtn"
                          class="btn btn-info"
                          onclick="previewBlogContent()"
                        >
                          Preview
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="loader" id="blogContentLoader"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
      // Check authentication
      function checkAuth() {
        const isAuthenticated = localStorage.getItem('isAuthenticated');
        if (!isAuthenticated) {
          window.location.href = '/login.html';
        }
      }

      // Logout function
      function logout() {
        localStorage.removeItem('isAuthenticated');
        window.location.href = '/login.html';
      }

      // API endpoints
      const API_BASE = '/api';
      const TOPICS_API = `${API_BASE}/topics`;
      const BLOGS_API = `${API_BASE}/blogs`;

      // Loading state management
      function setLoading(elementId, isLoading) {
        const element = document.getElementById(elementId);
        const loader = document.getElementById(`${elementId}Loader`);

        if (!element || !loader) return;

        if (isLoading) {
          element.classList.add('loading');
          loader.style.display = 'block';
        } else {
          element.classList.remove('loading');
          loader.style.display = 'none';
        }
      }

      // Fetch and display topics
      async function fetchTopics() {
        const topicList = document.getElementById('topicsList');
        if (!topicList) return;

        setLoading('topicsList', true);
        try {
          const response = await fetch(`${TOPICS_API}`);
          const topics = await response.json();

          topicList.innerHTML = topics.data
            .map(
              (topic) => `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <span>${topic.title || topic.name}</span>
              <button id="generateBlog${topic.id}" class="btn btn-sm btn-success" onclick="generateBlog('${topic.id}')">
                Create Blog
                <div class="loader" id="generateBlog${topic.id}Loader"></div>
              </button>
            </div>
          `,
            )
            .join('');
        } catch (error) {
          console.error('Error fetching topics:', error);
        } finally {
          setLoading('topicsList', false);
        }
      }

      // Generate topics
      async function suggestTopics() {
        const topicForm = document.getElementById('topicForm');
        if (!topicForm) return;

        try {
          setLoading('topicForm', true);
          const response = await fetch(`${TOPICS_API}/generate`);
          await response.json();
          await fetchTopics();
        } catch (error) {
          console.error('Error generating topics:', error);
        } finally {
          setLoading('topicForm', false);
        }
      }

      // Add manual topic
      async function addManualTopic(topic) {
        const topicForm = document.getElementById('topicForm');
        if (!topicForm) return;

        try {
          setLoading('topicForm', true);
          const response = await fetch(TOPICS_API, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topic: topic }),
          });
          await response.json();
          await fetchTopics();
        } catch (error) {
          console.error('Error adding topic:', error);
        } finally {
          setLoading('topicForm', false);
        }
      }

      // Generate blog for a topic
      async function generateBlog(topicId) {
        const buttonId = `generateBlog${topicId}`;
        const button = document.getElementById(buttonId);
        if (!button) return;

        try {
          setLoading(buttonId, true);
          const response = await fetch(
            `${BLOGS_API}/generate?topicId=${topicId}`,
          );
          const result = await response.json();

          if (result.status === 'success') {
            // Delete the topic using the API
            await fetch(`${TOPICS_API}/${topicId}/used`, {
              method: 'PUT',
            });
            // Refresh topics list
            await fetchTopics();
            // Refresh blogs list
            await fetchBlogs();
          }
        } catch (error) {
          console.error('Error generating blog:', error);
        } finally {
          setLoading(buttonId, false);
        }
      }

      // Fetch and display blogs
      async function fetchBlogs() {
        const pendingList = document.getElementById('pendingList');
        const approvedList = document.getElementById('approvedList');
        if (!pendingList || !approvedList) return;

        try {
          setLoading('pendingList', true);
          setLoading('approvedList', true);

          const response = await fetch(BLOGS_API);
          const blogs = await response.json();

          // Update pending blogs list
          pendingList.innerHTML = blogs.data.pending
            .map(
              (blog) => `
            <div class="list-group-item list-group-item-action">
              <div class="d-flex justify-content-between align-items-center">
                <span onclick="viewBlogContent('${blog.id}')" style="cursor: pointer">${blog.title}</span>
                <div>
                  <button id="approve${blog.id}" class="btn btn-sm btn-success" style="color: white;" onclick="approveBlog('${blog.id}')" title="Approve">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                      <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    <div class="loader" id="approve${blog.id}Loader"></div>
                  </button>
                  <button id="reject${blog.id}" class="btn btn-sm btn-danger" onclick="rejectBlog('${blog.id}')" title="Reject">
                    X
                    <div class="loader" id="reject${blog.id}Loader"></div>
                  </button>
                </div>
              </div>
            </div>
          `,
            )
            .join('');

          // Update approved blogs list
          approvedList.innerHTML = blogs.data.approved
            .map(
              (blog) => `
            <div class="list-group-item list-group-item-action">
              <div class="d-flex justify-content-between align-items-center">
                <span onclick="viewBlogContent('${blog.id}')" style="cursor: pointer">${blog.title}</span>
                <button id="delete${blog.id}" class="btn btn-sm btn-danger" onclick="rejectBlog('${blog.id}')" title="Delete">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                  </svg>
                  <div class="loader" id="delete${blog.id}Loader"></div>
                </button>
              </div>
            </div>
          `,
            )
            .join('');
        } catch (error) {
          console.error('Error fetching blogs:', error);
        } finally {
          setLoading('pendingList', false);
          setLoading('approvedList', false);
        }
      }

      // View blog content
      async function viewBlogContent(blogId) {
        try {
          setLoading('blogContent', true);
          const response = await fetch(`${BLOGS_API}/${blogId}`);
          const blog = await response.json();
          const contentElement = document.getElementById('blogContent');
          const copyHtmlBtn = document.getElementById('copyHtmlBtn');
          const saveChangesBtn = document.getElementById('saveChangesBtn');

          if (contentElement) {
            contentElement.innerHTML = `
              <div class="prose">
                ${blog.data.content}
              </div>
            `;
            // Store the current blog ID for editing
            contentElement.dataset.blogId = blogId;
            // Show copy HTML button
            if (copyHtmlBtn) {
              copyHtmlBtn.style.display = 'inline-block';
            }
            // Show save changes button
            if (saveChangesBtn) {
              saveChangesBtn.style.display = 'inline-block';
            }
          }
        } catch (error) {
          console.error('Error fetching blog content:', error);
        } finally {
          setLoading('blogContent', false);
        }
      }

      // Copy blog HTML to clipboard
      function copyBlogHtml() {
        const blogContent = document.getElementById('blogContent');
        if (!blogContent) return;

        const content = blogContent.querySelector('.prose').innerHTML;
        navigator.clipboard
          .writeText(content)
          .then(() => {
            // Show a temporary success message
            const copyBtn = document.getElementById('copyHtmlBtn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
              <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
            </svg>
            Copied!
          `;
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
            }, 2000);
          })
          .catch((err) => {
            console.error('Failed to copy content:', err);
          });
      }

      // Toggle blog edit mode
      function toggleBlogEdit() {
        const blogContent = document.getElementById('blogContent');
        const blogEditor = document.getElementById('blogEditor');
        const editor = document.getElementById('blogContentEditor');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');

        if (blogContent && blogEditor && editor) {
          // Get the current content
          const currentContent = blogContent.querySelector('.prose').innerHTML;
          editor.value = currentContent;

          // Toggle visibility
          blogContent.style.display = 'none';
          blogEditor.style.display = 'block';

          // Hide copy HTML and save changes buttons
          if (copyHtmlBtn) {
            copyHtmlBtn.style.display = 'none';
          }
          if (saveChangesBtn) {
            saveChangesBtn.style.display = 'none';
          }
        }
      }

      // Preview blog content
      function previewBlogContent() {
        const blogContent = document.getElementById('blogContent');
        const blogEditor = document.getElementById('blogEditor');
        const editor = document.getElementById('blogContentEditor');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');

        if (blogContent && blogEditor && editor) {
          // Update preview content
          blogContent.querySelector('.prose').innerHTML = editor.value;

          // Toggle visibility
          blogContent.style.display = 'block';
          blogEditor.style.display = 'none';

          // Show copy HTML and save changes buttons
          if (copyHtmlBtn) {
            copyHtmlBtn.style.display = 'inline-block';
          }
          if (saveChangesBtn) {
            saveChangesBtn.style.display = 'inline-block';
          }
        }
      }

      // Cancel blog edit
      function cancelBlogEdit() {
        const blogContent = document.getElementById('blogContent');
        const blogEditor = document.getElementById('blogEditor');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');

        if (blogContent && blogEditor) {
          blogContent.style.display = 'block';
          blogEditor.style.display = 'none';

          // Show copy HTML and save changes buttons
          if (copyHtmlBtn) {
            copyHtmlBtn.style.display = 'inline-block';
          }
          if (saveChangesBtn) {
            saveChangesBtn.style.display = 'inline-block';
          }
        }
      }

      // Save blog content
      async function saveBlogContent() {
        const blogContent = document.getElementById('blogContent');
        const editor = document.getElementById('blogContentEditor');
        const blogId = blogContent.dataset.blogId;
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');

        if (!blogId || !editor) return;

        try {
          setLoading('blogContent', true);
          const response = await fetch(`${BLOGS_API}/update/${blogId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              content: editor.value,
            }),
          });

          if (response.ok) {
            // Update the content display
            blogContent.querySelector('.prose').innerHTML = editor.value;
            // Switch back to view mode
            blogContent.style.display = 'block';
            blogEditor.style.display = 'none';

            // Show copy HTML and save changes buttons
            if (copyHtmlBtn) {
              copyHtmlBtn.style.display = 'inline-block';
            }
            if (saveChangesBtn) {
              saveChangesBtn.style.display = 'inline-block';
            }
          }
        } catch (error) {
          console.error('Error saving blog content:', error);
        } finally {
          setLoading('blogContent', false);
        }
      }

      // Blog management functions
      async function approveBlog(blogId) {
        const buttonId = `approve${blogId}`;
        const button = document.getElementById(buttonId);
        if (!button) return;

        try {
          setLoading(buttonId, true);
          await fetch(`${BLOGS_API}/approve/${blogId}`);
          await fetchBlogs();
        } catch (error) {
          console.error('Error approving blog:', error);
        } finally {
          setLoading(buttonId, false);
        }
      }

      async function rejectBlog(blogId) {
        const buttonId = `reject${blogId}`;
        const button = document.getElementById(buttonId);
        if (!button) return;

        try {
          setLoading(buttonId, true);
          await fetch(`${BLOGS_API}/reject/${blogId}`);
          await fetchBlogs();
        } catch (error) {
          console.error('Error rejecting blog:', error);
        } finally {
          setLoading(buttonId, false);
        }
      }

      // Form submission handler
      document
        .getElementById('topicForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();
          const isManualTopic = document.getElementById('manualTopic').checked;

          if (isManualTopic) {
            const topicInput = document.getElementById('topicInput');
            if (topicInput && topicInput.value.trim()) {
              await addManualTopic(topicInput.value.trim());
              topicInput.value = '';
            }
          } else {
            await suggestTopics();
          }
        });

      // Toggle manual topic input based on radio selection
      document
        .querySelectorAll('input[name="topicMethod"]')
        .forEach((radio) => {
          radio.addEventListener('change', function () {
            const manualInput = document.getElementById('manualTopicInput');
            if (manualInput) {
              manualInput.style.display =
                this.id === 'manualTopic' ? 'block' : 'none';
            }
          });
        });

      // Initial load
      document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        fetchTopics();
        fetchBlogs();
      });
    </script>
  </body>
</html>
